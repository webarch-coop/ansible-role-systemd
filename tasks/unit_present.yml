---
- name: Systemd unit configuration
  block:

    - name: Set systemd_file_changed to false
      ansible.builtin.set_fact:
        systemd_file_changed: false

    - name: Debug the systemd unit variables
      ansible.builtin.debug:
        var: systemd_unit
        verbosity: 2

    - name: Include the package install tasks when defined
      ansible.builtin.include_tasks: pkg_present.yml
      loop: "{{ systemd_unit.pkgs }}"
      loop_control:
        loop_var: systemd_pkg
        label: "{{ systemd_pkg }}"
      when:
        - systemd_unit.pkgs is defined
        - systemd_unit.pkgs | length > 0

    - name: Include check tasks
      ansible.builtin.include_tasks: checks.yml

    - name: Include the systemd unit file absent tasks
      ansible.builtin.include_tasks: file_absent.yml
      loop: "{{ systemd_unit.files }}"
      loop_control:
        loop_var: systemd_file
        label: "{{ systemd_file.path | basename }}"
      when:
        - systemd_file.state is defined
        - systemd_file.state == "absent"

    - name: Include the systemd unit file edited, present or templated tasks
      ansible.builtin.include_tasks: file_present.yml
      loop: "{{ systemd_unit.files }}"
      loop_control:
        loop_var: systemd_file
        label: "{{ systemd_file.path | basename }}"
      when: >-
        ( systemd_file.state is not defined ) or
        ( systemd_file.state is regex('^edited|present|templated$') )

    - name: Set the unit state and restart it when the unit file exists
      block:

        - name: Unit state set
          ansible.builtin.systemd:
            name: "{{ systemd_unit.name }}"
            state: "{{ systemd_unit.unit_state | default('started') }}"

        - name: Systemd unit restarted
          ansible.builtin.systemd:
            service: "{{ systemd_unit.name }}"
            state: restarted
          when:
            - systemd_file_changed is defined
            - systemd_file_changed | bool

      when: systemd_file_state.stat.exists | bool

    - name: Stat the systemd unit file
      ansible.builtin.stat:
        path: "{{ systemd_file.path }}"
      register: systemd_file_state

  tags:
    - systemd
...
